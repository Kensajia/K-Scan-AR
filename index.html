<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>K-Scan AR - Acceso</title>
	<link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Estilos Base Comunes */
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 400px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        /* Estilos de Tema CLARO */
        .light-theme { background-color: #f4f4f4; color: #333; }
        .light-theme .container { background: white; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .light-theme button { background: #007bff; color: white; }
        .light-theme .secondary-button { background: #6c757d; }
        .light-theme input[type="text"] { border: 1px solid #ccc; }
        .light-theme .logo { filter: drop-shadow(0 0 1px #888); }

        /* Estilos de Tema OSCURO */
        .dark-theme { background-color: #1a1a1a; color: #f4f4f4; }
        .dark-theme .container { background: #2c2c2c; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); }
        .dark-theme button { color: #f4f4f4; border: 1px solid #666; }
        .dark-theme #access-button, .dark-theme .project-selection-item .access-btn { background: #007bff; border-color: #007bff; }
        .dark-theme .secondary-button { background: #3c3c3c; }
        .dark-theme .delete-btn { background: #dc3545; border-color: #dc3545; }
        .dark-theme input[type="text"] { background: #3c3c3c; color: white; border: 1px solid #4a4a4a; }
        .dark-theme .logo {
			background: white;      /* Fondo blanco */
			border: 1px solid white;/* Borde blanco */
			padding: 12px;           /* Opcional: separa el borde del contenido */
			border-radius: 15px;     /* Opcional */
			filter: drop-shadow(0 0 5px white);           /* none; Para quitar el drop-shadow */
		}

        /* Estilos comunes del formulario */
        label { display: block; text-align: left; margin-top: 10px; font-weight: bold; }
        input[type="text"] {
            padding: 10px; margin: 5px 0 15px 0; border-radius: 5px; width: calc(100% - 20px); font-size: 16px;
        }
        button {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 5px;
        }
        #error-message { color: red; margin-top: 10px; display: none; }
        .logo { margin-bottom: 20px; max-width: 150px; }
        
        /* Selector de Tema (Pie de Página) */
        .theme-selector { 
            position: fixed; bottom: 15px; right: 15px; padding: 10px; border-radius: 5px; font-size: 0.9em; 
            background: inherit; border: 0px solid currentColor; transition: all 0.3s;  
        }
        .theme-selector label, .theme-selector select { padding: 0; margin: 0; line-height: 2; color: inherit; text-align: center;}
        .theme-selector select { padding: 5px; border-radius: 5px; background: inherit; border: 1px solid currentColor; }
        
        /* Estilos específicos de la vista de selección */
        #selection-list { text-align: left; margin-top: 20px; }
        .project-selection-item { 
            border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; 
            display: flex; flex-direction: column; 
        }
        .project-selection-item h3 { margin: 0 0 10px 0; font-size: 1em; }
        
        .selection-actions {
            display: flex; justify-content: space-between; align-items: center; margin-top: 10px;
        }
        .selection-actions button { margin: 0 0 0 5px; padding: 8px 15px; font-size: 14px; }

        .loading-view { text-align: center; font-size: 1.2em; }
		
		
		/* Ocultar select original */
.theme-selector select {
    opacity: 0;
    width: 0;
    height: 0;
    pointer-events: none;
    position: absolute;
}

/* Nueva barra visual de círculos */
.theme-circles {
    display: flex;
    gap: 12px;
    margin-top: 8px;
    justify-content: center;
}

.theme-circles .circle {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    transition: 0.25s ease;
}

/* Colores reales de los temas */
.circle[data-value="auto"] {
    background: linear-gradient(135deg, #000 50%, #fff 50%);
}

.circle[data-value="light"] {
    background: #fff;
    border: 1px solid #aaa;
}

.circle[data-value="dark"] {
    background: #000;
}

/* Hover iluminado */
.circle:hover {
    transform: scale(1.18);
    box-shadow: 0 0 8px rgba(255,255,255,0.8);
}

/* Tema activo */
.circle.active {
    transform: scale(1.35);
    box-shadow: 0 0 12px rgba(255,255,255,1);
}

/* Tooltip */
.circle::after {
    content: attr(data-label);
    opacity: 0;
    position: absolute;
    top: -28px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.75);
    padding: 3px 6px;
    font-size: 11px;
    color: white;
    border-radius: 4px;
    transition: 0.2s ease;
    pointer-events: none;
    white-space: nowrap;
}

.circle:hover::after {
    opacity: 1;
}

		
    </style>
</head>
<body class="light-theme">

    <div class="container">
        <img src="https://cdn.store.link/uploads/store10333/store-logo.svg?versionId=O23kSU1KTku9CiHwepZjGq5XxjtmbLNG" alt="Logo Kensajia" class="logo">

        <div id="loading-view" class="loading-view">
            <p>Cargando datos de proyecto...</p>
        </div>

        <div id="input-view" style="display: none;">
            <h2>Ingresar Nuevo Acceso</h2>
            <label for="user-name">Tu Nombre (opcional):</label>
            <input type="text" id="user-name" placeholder="IDENTIFICADOR">
            
            <label for="user-code">Código de Usuario:</label>
            <input type="text" id="user-code" placeholder="CODIGO UNICO" maxlength="30">
            
            <button onclick="handleAccessAttempt()" id="access-button">Acceder</button>
            <button onclick="showSelectionView(getStoredCodes())" id="back-button" class="secondary-button" style="display: none;">Usuarios Guardados</button>
            <p id="error-message"></p>
        </div>

        <div id="selection-view" style="display: none;">
            <h2>Usuarios Guardados</h2>
            <div id="selection-list">
                </div>
            <div style="margin-top: 20px;">
                <button onclick="showInputView()" class="secondary-button">Nuevo Usuario</button>
            </div>
        </div>
    </div>
    
<div class="theme-selector">
    <label for="theme-select">Tema</label>

    <select id="theme-select" onchange="setTheme(this.value)">
        <option value="auto">Automático</option>
        <option value="light">Claro</option>
        <option value="dark">Oscuro</option>
    </select>

    <!-- Círculos visuales -->
    <div class="theme-circles">
        <div class="circle" data-value="auto" data-label="Automático"></div>
        <div class="circle" data-value="light" data-label="Claro"></div>
        <div class="circle" data-value="dark" data-label="Oscuro"></div>
    </div>
</div>


    <script>
        // =====================================================================
        // 1. CONSTANTES Y CARGA DE DATOS
        // =====================================================================
        let ProyectosAR = {}; 
        const LOCAL_STORAGE_KEY = 'arUserCodes';
        const LOCAL_STORAGE_THEME = 'arThemePreference';
        
        async function loadProjectData() {
            try {
                // RUTA: index-vault/IndexSet.json
                const response = await fetch('./index-vault/IndexSet.json'); 
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                ProyectosAR = await response.json();
                
                document.getElementById('loading-view').style.display = 'none';
                initializeUI(); 
                
            } catch (error) {
                console.error("No se pudo cargar la tabla de proyectos:", error);
                document.getElementById('loading-view').innerHTML = '<img src="https://cdn-icons-png.flaticon.com/128/4196/4196319.png" style="width:80px;"><h1>¡Ups!</h1><h2>Ocurrió un inconveniente.</h2><p>La información no se pudo cargar correctamente.</p>';
            }
        }
        
        // =====================================================================
        // 2. GESTIÓN DE TEMAS
        // =====================================================================
        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme(theme) {
            const body = document.body;
            body.classList.remove('light-theme', 'dark-theme');

            if (theme === 'auto') {
                const systemTheme = getSystemTheme();
                body.classList.add(systemTheme + '-theme');
            } else {
                body.classList.add(theme + '-theme');
            }
        }

        function setTheme(preference) {
            localStorage.setItem(LOCAL_STORAGE_THEME, preference);
            applyTheme(preference);
        }
		
		// Clic en los círculos → cambiar select y tema
document.querySelectorAll(".theme-circles .circle").forEach(circle => {
    circle.addEventListener("click", () => {
        const value = circle.dataset.value;

        // Cambiar select real
        const select = document.getElementById("theme-select");
        select.value = value;

        // Activar tema con tu misma función
        setTheme(value);
    });
});

// Al aplicar un tema → marcar círculo activo
function updateActiveCircle(theme) {
    document.querySelectorAll(".theme-circles .circle").forEach(c => {
        c.classList.toggle("active", c.dataset.value === theme);
    });
}

// Sobrescribimos applyTheme para actualizar círculos visuales
const originalApplyTheme = applyTheme;
applyTheme = function(theme) {
    originalApplyTheme(theme);
    updateActiveCircle(theme);
};

// Primera carga desde localStorage
updateActiveCircle(localStorage.getItem(LOCAL_STORAGE_THEME) || "auto");

        
        // =====================================================================
        // 3. GESTIÓN DE CÓDIGOS GUARDADOS (LocalStorage)
        // =====================================================================

        function getStoredCodes() {
            const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        function saveCode(code, name) {
            let storedCodes = getStoredCodes();
            const projectData = ProyectosAR[code];
            
            // Si el código ya está almacenado, salimos.
            if (storedCodes.some(item => item.code === code)) return;

            // Almacenamos solo código, nombre y ruta.
            storedCodes.push({ 
                code: code, 
                name: name, 
                ruta: projectData.ruta
            });
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(storedCodes));
        }

        function deleteCode(codeToDelete) {
            let storedCodes = getStoredCodes();
            storedCodes = storedCodes.filter(item => item.code !== codeToDelete);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(storedCodes));
            
            showSelectionView(storedCodes);
        }
        
        // FUNCIÓN DE REDIRECCIÓN SIMPLE (sin parámetro 'p')
        function redirectToProject(code, ruta) {
            const basePath = window.location.href.split('index.html')[0] || window.location.href;
            window.location.href = `${basePath}module/${ruta}/?code=${code}`;
        }

        function handleAccessAttempt() {
            const userCodeInput = document.getElementById('user-code');
            const userNameInput = document.getElementById('user-name');
            const errorMessage = document.getElementById('error-message');
            
            // Se permite mayúsculas/minúsculas. La clave JSON debe coincidir con el input.
            const code = userCodeInput.value.trim(); 
            let name = userNameInput.value.trim();

            errorMessage.style.display = 'none';

            if (!code) {
                errorMessage.textContent = 'Por favor, ingresa el código único de usuario.';
                errorMessage.style.display = 'block';
                return;
            }

            // Si el nombre está vacío, usa el código como identificador
            if (!name) {
                name = code; 
            }

            if (ProyectosAR[code]) { 
                const project = ProyectosAR[code];
                
                saveCode(code, name);
                
                redirectToProject(code, project.ruta); 
            } else {
                errorMessage.textContent = 'Código no válido. Por favor, verifique su código de usuario.';
                errorMessage.style.display = 'block';
            }
        }
        
        function showSelectionView(storedCodes) {
            const selectionList = document.getElementById('selection-list');
            selectionList.innerHTML = ''; 

            if (storedCodes.length === 0) {
                 showInputView(false); 
                 return;
            }
            
            document.getElementById('back-button').style.display = 'inline-block';

            storedCodes.forEach(item => {
                const projectDiv = document.createElement('div');
                projectDiv.className = 'project-selection-item';

                const title = document.createElement('h3');
                title.textContent = item.name + ` (Código: ${item.code})`;
                projectDiv.appendChild(title);

                const actionContainer = document.createElement('div');
                actionContainer.className = 'selection-actions';
                
                // Botón de Acceder
                const startButton = document.createElement('button');
                startButton.textContent = 'Acceder';
                startButton.className = 'access-btn';
                startButton.onclick = () => {
                    redirectToProject(item.code, item.ruta); // Llamada simple
                };
                
                actionContainer.appendChild(startButton);

                // Botón de Eliminar
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Eliminar';
                deleteButton.className = 'delete-btn';
                deleteButton.onclick = () => deleteCode(item.code); 
                
                actionContainer.appendChild(deleteButton);
                projectDiv.appendChild(actionContainer);
                selectionList.appendChild(projectDiv);
            });

            document.getElementById('input-view').style.display = 'none';
            document.getElementById('selection-view').style.display = 'block';
        }

        function showInputView(showBackButton = true) {
            document.getElementById('selection-view').style.display = 'none';
            document.getElementById('input-view').style.display = 'block';
            document.getElementById('user-code').value = '';
            document.getElementById('user-name').value = '';
            
            document.getElementById('back-button').style.display = showBackButton ? 'inline-block' : 'none';
        }
        
        // =====================================================================
        // 4. INICIO Y LÓGICA DE UI
        // =====================================================================
        function initializeUI() {
            const storedCodes = getStoredCodes();
            
            if (storedCodes.length > 0) {
                showSelectionView(storedCodes);
            } else {
                showInputView(false); 
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem(LOCAL_STORAGE_THEME) || 'auto';
            applyTheme(savedTheme);

            loadProjectData();
        });
    </script>
</body>
</html>



