<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>K-Scan AR - Acceso</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Estilos Base Comunes */
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 400px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        /* Estilos de Tema CLARO */
        .light-theme { background-color: #f4f4f4; color: #333; }
        .light-theme .container { background: white; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .light-theme button { background: #007bff; color: white; }
        .light-theme .secondary-button { background: #6c757d; }
        .light-theme input[type="text"] { border: 1px solid #ccc; }
        .light-theme .logo { filter: drop-shadow(0 0 1px #888); }

        /* Estilos de Tema OSCURO */
        .dark-theme { background-color: #1a1a1a; color: #f4f4f4; }
        .dark-theme .container { background: #2c2c2c; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); }
        .dark-theme button { background: #4a4a4a; color: #f4f4f4; border: 1px solid #666; }
        .dark-theme .secondary-button { background: #3c3c3c; }
        .dark-theme input[type="text"] { background: #3c3c3c; color: white; border: 1px solid #4a4a4a; }
        .dark-theme .logo {
			background: white;      /* Fondo blanco */
			border: 1px solid white;/* Borde blanco */
			padding: 12px;           /* Opcional: separa el borde del contenido */
			border-radius: 15px;     /* Opcional */
			filter: drop-shadow(0 0 5px white);           /* none; Para quitar el drop-shadow */
		}

        /* Estilos comunes del formulario */
        label { display: block; text-align: left; margin-top: 10px; font-weight: bold; }
        input[type="text"] {
            padding: 10px; margin: 5px 0 15px 0; border-radius: 5px; width: calc(100% - 20px); font-size: 16px;
        }
        button {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 5px;
        }
        #error-message { color: red; margin-top: 10px; display: none; }
        .logo { margin-bottom: 20px; max-width: 150px; }
        
        /* Selector de Tema (Pie de Página) */
        .theme-selector { 
            position: fixed; bottom: 15px; right: 15px; padding: 10px; border-radius: 5px; font-size: 0.9em; 
            background: inherit; border: 1px solid currentColor; transition: all 0.3s;
        }
        .theme-selector label, .theme-selector select { color: inherit; }
        .theme-selector select { padding: 5px; border-radius: 5px; background: inherit; border: 1px solid currentColor; }
        
        /* Estilos específicos de la vista de selección */
        #selection-list { text-align: left; margin-top: 20px; }
        .project-selection-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .project-selection-item h3 { margin: 0 0 10px 0; font-size: 1em; }
        .project-selection-item button { margin-left: 10px; }
        .loading-view { text-align: center; font-size: 1.2em; }
    </style>
</head>
<body class="light-theme">

    <div class="container">
        <img src="https://cdn.store.link/uploads/store10333/store-logo.svg?versionId=O23kSU1KTku9CiHwepZjGq5XxjtmbLNG" alt="Logo Kensajia" class="logo">

        <div id="loading-view" class="loading-view">
            <p>Cargando datos de proyecto...</p>
        </div>

        <div id="input-view" style="display: none;">
            <h2>Ingresar Nuevo Acceso</h2>
            <label for="user-name">Tu Nombre:</label>
            <input type="text" id="user-name" placeholder="IDENTIFICADOR">
            <p></p>
            <label for="user-code">Código Único:</label>
            <input type="text" id="user-code" placeholder="CODIGO" >
            
            <button onclick="handleAccessAttempt()" id="access-button">Acceder</button>
            <button onclick="showSelectionView(getStoredCodes())" id="back-button" class="secondary-button" style="display: none;">Nuevo Código</button>
            <p id="error-message"></p>
        </div>

        <div id="selection-view" style="display: none;">
            <h2>Códigos Guardados</h2>
            <div id="selection-list">
                </div>
            <div style="margin-top: 20px;">
                <button onclick="showInputView()" class="secondary-button">Ingresar Nuevo Código</button>
            </div>
        </div>
    </div>
    
    <div class="theme-selector">
        <label for="theme-select">Tema:</label>
        <select id="theme-select" onchange="setTheme(this.value)">
            <option value="auto">Automático</option>
            <option value="light">Claro</option>
            <option value="dark">Oscuro</option>
        </select>
    </div>


    <script>
        // =====================================================================
        // 1. CARGA DINÁMICA DE LA TABLA DE BÚSQUEDA GLOBAL (desde JSON)
        // =====================================================================
        let ProyectosAR = {}; // Se inicializa como un objeto vacío
        const LOCAL_STORAGE_KEY = 'arUserCodes';
        const LOCAL_STORAGE_THEME = 'arThemePreference';

        async function loadProjectData() {
            try {
                // RUTA ACTUALIZADA: /index-vault/IndexSet.json
                const response = await fetch('./index-vault/IndexSet.json'); 
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Asigna los datos a la variable global ProyectosAR
                ProyectosAR = await response.json();
                
                // Ocultar la vista de carga
                document.getElementById('loading-view').style.display = 'none';
                
                // Una vez cargado, inicia la lógica de la interfaz de usuario
                initializeUI(); 
                
            } catch (error) {
                console.error("No se pudo cargar la tabla de proyectos:", error);
                document.getElementById('loading-view').innerHTML = '<h1>Error: No se pudo cargar la tabla de códigos.</h1><p>Asegúrate de que el archivo **IndexSet.json** exista en la carpeta **index-vault**.</p>';
            }
        }
        
        // =====================================================================
        // 2. GESTIÓN DE TEMAS
        // =====================================================================
        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme(theme) {
            const body = document.body;
            body.classList.remove('light-theme', 'dark-theme');

            if (theme === 'auto') {
                const systemTheme = getSystemTheme();
                body.classList.add(systemTheme + '-theme');
            } else {
                body.classList.add(theme + '-theme');
            }
        }

        function setTheme(preference) {
            localStorage.setItem(LOCAL_STORAGE_THEME, preference);
            applyTheme(preference);
        }
        
        // =====================================================================
        // 3. GESTIÓN DE ACCESO Y REDIRECCIÓN
        // =====================================================================

        function getStoredCodes() {
            const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        function saveCode(code, name) {
            let storedCodes = getStoredCodes();
            const projectData = ProyectosAR[code];
            
            // Si el código ya está almacenado, salimos.
            if (storedCodes.some(item => item.code === code)) return;

            // Almacenamos el código, el nombre que el usuario ingresó y los datos del proyecto.
            storedCodes.push({ 
                code: code, 
                name: name, // Nombre ingresado por el usuario
                ruta: projectData.ruta,
                presentaciones: projectData.presentacion 
            });
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(storedCodes));
        }
        
        function redirectToProject(code, ruta, presentationIndex = 0) {
            const basePath = window.location.href.split('index.html')[0] || window.location.href;
            // El parámetro 'p' indica qué presentación debe cargar (0, 1, 2, etc.)
            window.location.href = `${basePath}module/${ruta}/?code=${code}&p=${presentationIndex}`;
        }

        function handleAccessAttempt() {
            const userCodeInput = document.getElementById('user-code');
            const userNameInput = document.getElementById('user-name');
            const errorMessage = document.getElementById('error-message');
            const code = userCodeInput.value.toUpperCase().trim();
            const name = userNameInput.value.trim();

            errorMessage.style.display = 'none';

            if (!name) {
                errorMessage.textContent = 'Por favor, ingresa un nombre para identificar este acceso.';
                errorMessage.style.display = 'block';
                return;
            }

            if (ProyectosAR[code]) {
                const project = ProyectosAR[code];
                
                // 1. Guardar el código y el nombre ingresado.
                saveCode(code, name);
                
                // 2. Redirigir a la primera presentación por defecto (índice 0).
                redirectToProject(code, project.ruta, 0); 
            } else {
                errorMessage.textContent = 'Código no válido. Por favor, verifica el código único.';
                errorMessage.style.display = 'block';
            }
        }
        
        function showSelectionView(storedCodes) {
            const selectionList = document.getElementById('selection-list');
            selectionList.innerHTML = ''; 

            if (storedCodes.length === 0) {
                 // Si no hay códigos guardados, mostrar la vista de entrada.
                 showInputView(false); 
                 return;
            }

            storedCodes.forEach(item => {
                const projectDiv = document.createElement('div');
                projectDiv.className = 'project-selection-item';

                // Título del Proyecto (El nombre que el usuario tecleó)
                const title = document.createElement('h3');
                title.textContent = item.name + ` (Código: ${item.code})`;
                projectDiv.appendChild(title);

                // Selector de Presentación (Dropdown)
                const select = document.createElement('select');
                select.style.padding = '8px';
                select.style.borderRadius = '5px';
                select.style.marginRight = '10px';
                select.style.width = 'calc(100% - 130px)';
                
                // Opción por defecto
                const defaultOption = document.createElement('option');
                defaultOption.textContent = "Selecciona una presentación...";
                defaultOption.value = "";
                select.appendChild(defaultOption);

                // Llenar el dropdown con las opciones
                item.presentaciones.forEach((presName, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = presName;
                    select.appendChild(option);
                });
                projectDiv.appendChild(select);
                
                // Botón de Iniciar Escaneo
                const startButton = document.createElement('button');
                startButton.textContent = 'Acceder';
                startButton.disabled = true; 
                
                // Lógica para habilitar el botón y redirigir
                select.onchange = () => {
                    if (select.value !== "") {
                        startButton.disabled = false;
                    } else {
                        startButton.disabled = true;
                    }
                };

                startButton.onclick = () => {
                    const presentationIndex = select.value;
                    redirectToProject(item.code, item.ruta, presentationIndex);
                };
                
                projectDiv.appendChild(startButton);
                selectionList.appendChild(projectDiv);
            });

            document.getElementById('input-view').style.display = 'none';
            document.getElementById('selection-view').style.display = 'block';
        }

        function showInputView(showBackButton = true) {
            document.getElementById('selection-view').style.display = 'none';
            document.getElementById('input-view').style.display = 'block';
            document.getElementById('user-code').value = '';
            document.getElementById('user-name').value = '';
            
            // Mostrar u ocultar el botón "Nuevo Código" (que hace de botón de volver).
            document.getElementById('back-button').style.display = showBackButton ? 'inline-block' : 'none';
        }
        
        // =====================================================================
        // 4. INICIO: Carga de Datos y UI
        // =====================================================================
        function initializeUI() {
             // 1. Determinar la vista inicial después de cargar los datos
            const storedCodes = getStoredCodes();
            
            if (storedCodes.length > 0) {
                // Hay códigos guardados, mostramos el menú de selección
                showSelectionView(storedCodes);
            } else {
                // No hay códigos guardados, mostramos la entrada de código
                showInputView(false); // No hay códigos guardados, mostrar solo la entrada.
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Cargar el tema al inicio
            const savedTheme = localStorage.getItem(LOCAL_STORAGE_THEME) || 'auto';
            applyTheme(savedTheme);

            // Iniciar la carga de los datos JSON.
            loadProjectData();
        });
    </script>
</body>
</html>






