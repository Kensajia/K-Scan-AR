<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>AR Experience - Controles de Zoom en Pantalla</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        
        <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.6.0/dist/aframe-master.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
        
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        
        <script>
            // =====================================================================
            // 1. TABLA DE CONTENIDOS DIN√ÅMICA
            // =====================================================================
            const ContenidoModulo = {
                "susam-51162": { 
                    "MARCADOR_A": { type: "nft", url: "assets/T000001-SUSAM-01", resource: "https://www.youtube.com/embed/video_ejemplo_2?autoplay=1&controls=0" }, 
                    "MARCADOR_B": { type: "pattern", url: "assets/taza.patt", resource: "https://www.youtube.com/embed/kRCWvqJVWx8?autoplay=1&controls=0" }, 
                    "MARCADOR_C": { type: "disabled" } 
                },
            };

            // =====================================================================
            // 2. L√ìGICA DE CONTROL DE ZOOM (ESCALADO DE CONTENIDO)
            // =====================================================================
            let currentScale = 1.0;
            const scaleStep = 0.1;

            /** Aplica la escala a la entidad contenedora del contenido AR. */
            function applyScale(scale) {
                const contentContainer = document.getElementById('ar-content');
                if (contentContainer) {
                    contentContainer.setAttribute('scale', `${scale} ${scale} ${scale}`);
                    currentScale = scale;
                    console.log(`Escala AR ajustada a: ${scale}`);
                }
            }

            /** Bot√≥n: Acercar (Zoom In) */
            window.zoomIn = function() {
                // Limitamos el zoom m√°ximo
                if (currentScale < 3.0) {
                    applyScale(currentScale + scaleStep);
                }
            };

            /** Bot√≥n: Alejar (Zoom Out) */
            window.zoomOut = function() {
                // Limitamos el zoom m√≠nimo (para evitar que desaparezca)
                if (currentScale > 0.1) {
                    applyScale(currentScale - scaleStep);
                }
            };

            /** Bot√≥n: Restaurar */
            window.zoomReset = function() {
                applyScale(1.0);
            };


            // =====================================================================
            // 3. FUNCI√ìN DE INYECCI√ìN Y WEBRTC
            // =====================================================================
            function injectMarkers() {
                // ... (Tu l√≥gica de inyecci√≥n de marcadores aqu√≠, insertando en #ar-content) ...

                const scene = document.getElementById('scene');
                const contentContainer = document.getElementById('ar-content');
                const urlParams = new URLSearchParams(window.location.search);
                const userCode = urlParams.get('code'); 
                const recursos = ContenidoModulo[userCode] || null;

                if (!recursos || !scene) return;
                
                const loader = document.querySelector('.arjs-loader');
                if (loader) {
                    loader.style.display = 'none';
                }

                // Aqu√≠ ir√≠a la l√≥gica de creaci√≥n de NFT/Pattern, asegurando que 
                // los marcadores (markerEl) se a√±adan a contentContainer, no directamente a scene.
                
                // Ejemplo (simplificado, debes integrar tu l√≥gica completa):
                const markerEl = document.createElement('a-nft');
                // ... atributos ...
                contentContainer.appendChild(markerEl); // <--- A√ëADIR AL CONTENEDOR ESCALABLE

                // Inicializar la escala si el contenido ya carg√≥
                applyScale(1.0); 
            }
            
            function initWebcamStream() {
                // ... (Tu l√≥gica de inicializaci√≥n WebRTC y restricci√≥n de resoluci√≥n) ...

                const videoId = 'arjs-video-source';
                let videoEl = document.createElement('video');
                // ... (Creaci√≥n del elemento video) ...

                const constraints = { /* ... (Tus restricciones 1280x720) ... */ };

                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(stream) {
                        videoEl.srcObject = stream;
                        videoEl.onloadedmetadata = function() {
                            videoEl.play();
                            
                            const scene = document.getElementById('scene');
                            if (scene) {
                                scene.setAttribute('arjs', 
                                    `sourceType: video; 
                                     sourceUrl: #${videoId};
                                     trackingMethod: best; 
                                     debugUIEnabled: false;`);
                                
                                injectMarkers();
                            }
                        };
                    })
                    .catch(function(err) {
                        console.error("Error al iniciar la c√°mara (WebRTC):", err);
                        alert(`Error de c√°mara: Causa: ${err.name}. El zoom sigue fijo por el dispositivo.`);
                        injectMarkers(); 
                    });
            }

            document.addEventListener('DOMContentLoaded', initWebcamStream); 

        </script>

        <style>
            /* Estilos de la Marquesina (Loader) */
            .arjs-loader {
                height: 30px; 
                width: 100%;
                position: fixed; 
                top: 0;
                left: 0;
                background-color: rgba(0, 0, 0, 0.6); 
                z-index: 9999;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .arjs-loader div {
                text-align: center;
                font-size: 0.9em; 
                color: white;
            }

            /* Estilos para los Controles de Zoom */
            #ar-controls {
                position: fixed;
                bottom: 20px; /* Abajo de la pantalla */
                left: 50%;
                transform: translateX(-50%); /* Centrar */
                z-index: 999; /* Sobre la escena AR */
                display: flex;
                gap: 10px;
            }

            #ar-controls button {
                padding: 10px 15px;
                font-size: 1.2em;
                background: rgba(0, 0, 0, 0.5);
                color: white;
                border: 1px solid white;
                border-radius: 5px;
                cursor: pointer;
            }
        </style>
    </head>

    <body style="margin : 0px; overflow: hidden;">
        
        <div id="ar-controls">
            <button onclick="zoomOut()">‚ûñ Alejar</button>
            <button onclick="zoomReset()">üéØ Restaurar</button>
            <button onclick="zoomIn()">‚ûï Acercar</button>
        </div>

        <div class="arjs-loader">
            <div>INTENTO 201 - Cargando archivos de realidad aumentada...</div>
        </div>
        
        <a-scene
            vr-mode-ui="enabled: false;"
            renderer="logarithmicDepthBuffer: true; precision: medium;"
            embedded
            arjs="" 
            id="scene"
        >
            <a-entity id="ar-content"></a-entity> 

            <a-entity camera></a-entity> 
        </a-scene>
    </body>
</html>
