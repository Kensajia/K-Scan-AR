<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>K-Scan AR</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        
        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                    "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
                }
            }
        </script>

        <script type="module">
            import * as THREE from 'three';
            import { MindARThree } from 'mindar-image-three';

            // =====================================================================
            // 1. TABLA DE CONTENIDOS DIN츼MICA
            // Define el contenido que se mostrar치 para cada c칩digo de usuario
            // =====================================================================
            const ContenidoModulo = {
                "susam-51162": { 
                    // MARCADOR_A (칈ndice 0) -> Cuadro Azul Clickeable (abre YouTube)
                    "MARCADOR_A": { index: 0, resource: "https://www.youtube.com/embed/kRCWvqJVWx8?autoplay=1&controls=0", isClickable: true }, 
                    // MARCADOR_B (칈ndice 1) -> Cubo Rojo 3D
                    "MARCADOR_B": { index: 1, resource: "Contenido 3D (Caja)", isClickable: false }, 
                    // MARCADOR_C (칈ndice 2) -> Esfera Verde 3D
                    "MARCADOR_C": { index: 2, resource: "Contenido 3D (Esfera)", isClickable: false } 
                },
                // Puedes a침adir m치s c칩digos de usuario aqu칤 si tuvieras m치s archivos .mind o escenarios
            };

            document.addEventListener('DOMContentLoaded', () => {
                
                // 游띔 LECTURA DIN츼MICA DEL C칍DIGO DE USUARIO EN LA URL
                const urlParams = new URLSearchParams(window.location.search);
                const userCode = urlParams.get('code') || "susam-51162";
                const recursos = ContenidoModulo[userCode] || ContenidoModulo["susam-51162"];
                
                // Ruta del archivo .MIND (debe estar en la carpeta assets/)
                const targetsPath = './assets/targets.mind'; 

                // =====================================================================
                // 3. CREACI칍N DE CONTENIDO 3D DIN츼MICO
                // Crea el objeto 3D basado en la configuraci칩n del recurso
                // =====================================================================
                function createContent(config) {
                    if (config.isClickable) {
                        // RECURSO INTERACTIVO (Ejemplo: Abrir YouTube)
                        const geometry = new THREE.PlaneGeometry(1, 0.55);
                        // Cuadro azul semitransparente que se convierte en bot칩n
                        const material = new THREE.MeshBasicMaterial( {color: 0x00ffff, transparent: true, opacity: 0.5} ); 
                        const plane = new THREE.Mesh( geometry, material );
                        
                        plane.userData.url = config.resource;
                        plane.position.set(0, 0, 0.05); // Lo levanta un poco
                        return plane;

                    } else if (config.resource.includes("Caja")) {
                        // CUBO ROJO
                        const geometry = new THREE.BoxGeometry(1, 1, 1);
                        const material = new THREE.MeshBasicMaterial({ color: 0xFF0000 });
                        const box = new THREE.Mesh(geometry, material);
                        box.position.set(0, 0.5, 0); // Centrado sobre el marcador
                        return box;
                    } else if (config.resource.includes("Esfera")) {
                         // ESFERA VERDE
                        const geometry = new THREE.SphereGeometry( 0.5, 32, 16 );
                        const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
                        const sphere = new THREE.Mesh( geometry, material );
                        sphere.position.set(0, 0.5, 0); 
                        return sphere;
                    }
                    return new THREE.Object3D(); // Objeto vac칤o si no hay coincidencia
                }

                // =====================================================================
                // 4. INICIALIZACI칍N Y ASIGNACI칍N DE ANCLAS
                // =====================================================================
                const mindarThree = new MindARThree({
                    container: document.querySelector("#container"),
                    imageTargetSrc: targetsPath
                });
                const {renderer, scene, camera} = mindarThree;

                // ITERAR Y ASIGNAR EL CONTENIDO DIN츼MICO A CADA MARCADOR (칤ndice 0, 1, 2...)
                Object.values(recursos).forEach(config => {
                    if (config.index !== undefined) {
                        const anchor = mindarThree.addAnchor(config.index);
                        const content = createContent(config);
                        anchor.group.add(content);
                    }
                });

                // =====================================================================
                // 5. FUNCIONES DE RENDERIZADO Y CONTROL
                // =====================================================================

                const start = async() => {
                    await mindarThree.start();
                    // Mostrar contenedor de AR
                    document.querySelector("#container").style.display = 'block'; 
                    document.querySelector("#startButton").style.display = 'none'; 
                    document.querySelector("#stopButton").style.display = 'block'; 

                    renderer.setAnimationLoop(() => {
                        renderer.render(scene, camera);
                    });
                }

                const stop = () => {
                    mindarThree.stop();
                    renderer.setAnimationLoop(null);
                    // Ocultar contenedor de AR
                    document.querySelector("#container").style.display = 'none'; 
                    document.querySelector("#startButton").style.display = 'block'; 
                    document.querySelector("#stopButton").style.display = 'none'; 
                }

                const startButton = document.querySelector("#startButton");
                const stopButton = document.querySelector("#stopButton");

                startButton.addEventListener("click", () => {
                    start();
                });

                stopButton.addEventListener("click", () => {
                    stop();
                });
                
                // Listener de Raycasting (Click en el objeto AR)
                window.addEventListener('click', (event) => {
                    const raycaster = new THREE.Raycaster();
                    const mouse = new THREE.Vector2();

                    // Normaliza la posici칩n del clic en coordenadas de -1 a +1
                    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                    mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

                    raycaster.setFromCamera(mouse, camera);
                    
                    // Revisa si el clic intersecta con un objeto clickeable
                    Object.values(recursos).forEach(config => {
                        if (config.index !== undefined && config.isClickable) {
                            const anchor = mindarThree.anchors[config.index];
                            if (anchor && anchor.group.children.length > 0) {
                                const intersects = raycaster.intersectObjects(anchor.group.children, true);
                                
                                if (intersects.length > 0 && intersects[0].object.userData.url) {
                                    // Abre el enlace (YouTube) en una nueva pesta침a
                                    window.open(intersects[0].object.userData.url, '_blank');
                                }
                            }
                        }
                    });
                });
            });
        </script>
        
        <style>
            body { margin: 0; }
            #container {
                width: 100vw;
                height: 100vh;
                position: relative;
                overflow: hidden;
                display: none; /* Inicia oculto */
            }
            #control {
                position: fixed;
                top: 0;
                left: 0;
                z-index: 2;
                padding: 10px;
            }
            #stopButton { display: none; } /* Inicia oculto */
        </style>
    </head>
    
    <body>
        <div id="control">
            <button id="startButton">20 START AR</button> 
            <button id="stopButton">STOP AR</button>
        </div>
        <div id="container">
        </div>
    </body>
</html>
