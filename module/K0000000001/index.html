<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>AR Experience - MindAR FIX de Carga</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        

        <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.6.0/dist/aframe-master.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/mindar-image-aframe@1.2.5/dist/mindar-image-aframe.js"></script>

        
        <script>
            // =====================================================================
            // 1. TABLA DE CONTENIDOS DINÁMICA
            // =====================================================================
            const ContenidoModulo = {
                "susam-51162": { 
                    "MARCADOR_A": { type: "target", index: 0, resource: "https://www.youtube.com/embed/video_ejemplo_2?autoplay=1&controls=0" }, 
                    "MARCADOR_B": { type: "target", index: 1, resource: "assets/taza.patt" }, 
                    "MARCADOR_C": { type: "disabled" } 
                },
            };

            // =====================================================================
            // 2. FUNCIÓN DE INYECCIÓN DE MARCADORES (Se mantiene la lógica anterior)
            // =====================================================================

            function injectMarkers() {
                const scene = document.getElementById('scene');
                const urlParams = new URLSearchParams(window.location.search);
                const userCode = urlParams.get('code'); 
                const recursos = ContenidoModulo[userCode] || null;

                if (!recursos || !scene) return;
                
                // Ocultar el loader (marquesina)
                const loader = document.querySelector('.arjs-loader');
                if (loader) {
                    loader.style.display = 'none';
                }
                
                const markerKeys = Object.keys(recursos);
                markerKeys.forEach(key => {
                    const config = recursos[key];
                    if (config.type === "disabled") return;

                    if (config.type === "target") {
                        const markerEl = document.createElement('a-mindar-image');
                        markerEl.setAttribute('mindar-image-target', `targetIndex: ${config.index}`);
                        markerEl.setAttribute('id', key);

                        let contentEl;
                        if (config.resource.startsWith('http')) {
                            contentEl = document.createElement('a-plane');
                            contentEl.setAttribute('color', '#dc3545'); 
                            contentEl.setAttribute('width', 1);
                            contentEl.setAttribute('height', 0.5); 
                            contentEl.setAttribute('rotation', '0 0 0'); 
                            contentEl.setAttribute('position', '0 0 0.01'); 
                            contentEl.setAttribute('onclick', `window.open('${config.resource}', '_blank')`);
                            
                            const textEl = document.createElement('a-text');
                            textEl.setAttribute('value', `Toca para ver ${key} (YouTube)`);
                            textEl.setAttribute('width', 3);
                            textEl.setAttribute('position', '0 0 0');
                            textEl.setAttribute('align', 'center');
                            contentEl.appendChild(textEl);
                         } else {
                            contentEl = document.createElement('a-box');
                            contentEl.setAttribute('color', 'yellow');
                            contentEl.setAttribute('width', 0.5);
                            contentEl.setAttribute('height', 0.5);
                            contentEl.setAttribute('depth', 0.5);
                            contentEl.setAttribute('position', '0 0 0.25');
                         }
                         
                         markerEl.appendChild(contentEl);
                         scene.appendChild(markerEl);
                    }
                });
            }

            // CRÍTICO: Esperar a que la escena se cargue para dar tiempo a MindAR a inicializarse
            document.addEventListener('DOMContentLoaded', function() {
                // Esperamos un momento después de que toda la escena A-Frame se haya cargado
                document.querySelector('a-scene').addEventListener('loaded', function () {
                    setTimeout(injectMarkers, 500);
                });
            });

        </script>

        <style>
            .arjs-loader {
                height: 30px; 
                width: 100%;
                position: fixed; 
                top: 0;
                left: 0;
                background-color: rgba(0, 0, 0, 0.6); 
                z-index: 9999;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .arjs-loader div {
                text-align: center;
                font-size: 0.9em; 
                color: white;
            }
        </style>
    </head>

    <body style="margin : 0px; overflow: hidden;">
        
        <div class="arjs-loader">
            <div>Cargando MindAR, por favor espere... (Fix de inicialización activo)</div>
        </div>
        
        <a-scene
            
            mindar-image="imageTargetSrc: assets/targets.mind; filterMinCF:0.0001; filterBeta: 1;"
            vr-mode-ui="enabled: false;"
            renderer="logarithmicDepthBuffer: true; precision: medium;"
            embedded
            id="scene"
        >
            <a-entity camera></a-entity> 
        </a-scene>
    </body>
</html>
