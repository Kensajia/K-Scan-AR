<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>AR Experience - FIX Final</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/ar.js"></script>
        
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        
        <script>
            // =====================================================================
            // 1. TABLA DE CONTENIDOS DIN√ÅMICA DEL M√ìDULO AR
            // =====================================================================
            const ContenidoModulo = {
                "susam-51162": { 
                    // MARCADOR A: YouTube (usando Patr√≥n, por ejemplo)
                    "MARCADOR_A": { 
                        type: "image", url: "assets/T000001-SUSAM-01.fset", resource: "https://www.youtube.com/embed/kRCWvqJVWx8?autoplay=1&controls=0" 
                    }, 
                    // MARCADOR B: Contenido de Imagen Natural (Usando tus archivos NFT)
                    "MARCADOR_B": { 
                        type: "image", url: "assets/T000001-SUSAM-01.fset",  resource: "https://www.youtube.com/watch?v=mbuv4P10GLc?autoplay=1&controls=0" // Otro YouTube o contenido
                    }, 
                    "MARCADOR_C": { type: "disabled" } 
                },
                "otroCodigoEjemplo": { /* ... */ }
            };

            // =====================================================================
            // 2. COMPONENTES Y L√ìGICA DE INYECCI√ìN
            // =====================================================================

            // Componente para forzar el redibujo (Fix de Pantalla en Blanco)
            AFRAME.registerComponent('force-redraw', {
                init: function () {
                    // Esperar 3 segundos para que todo el DOM y la escena carguen
                    setTimeout(() => {
                        const sceneEl = this.el;
                        sceneEl.emit('arjs-video-loaded', null, false);
                        console.log("Forzando redibujo de A-Frame.");
                    }, 3000); 
                }
            });


            // L√≥gica para inyectar los marcadores y contenido
            function injectMarkers(scene) {
                const urlParams = new URLSearchParams(window.location.search);
                const userCode = urlParams.get('code'); 
                const recursos = ContenidoModulo[userCode] || null;

                if (!recursos) return;
                
                const markerKeys = Object.keys(recursos);
                const assetsEl = document.querySelector('a-assets');
                
                markerKeys.forEach(key => {
                    const config = recursos[key];
                    if (config.type === "disabled") return;

                    const markerEl = document.createElement('a-marker');
                    markerEl.setAttribute('type', config.type);
                    markerEl.setAttribute('preset', 'custom');
                    markerEl.setAttribute('url', config.url);
                    markerEl.setAttribute('id', key);
                    markerEl.setAttribute('raycaster', 'objects: .clickable');
                    markerEl.setAttribute('emitevents', 'true');
                    markerEl.setAttribute('cursor', 'fuse: false; rayOrigin: mouse;');

                    // INYECCI√ìN DE CONTENIDO: Solo Pl√°ners (YouTube/Web) o GLTF (si existe)
                    let contentEl;
                    
                    if (config.resource.endsWith('.glb')) {
                        // Modelo 3D (Si se agrega en el futuro)
                        contentEl = document.createElement('a-gltf-model');
                        contentEl.setAttribute('src', config.resource);
                        contentEl.setAttribute('scale', '0.5 0.5 0.5'); 
                        contentEl.setAttribute('rotation', '-90 0 0');
                    } else if (config.resource.startsWith('http')) {
                        // YouTube / URL Externa (Plano clickable)
                        contentEl = document.createElement('a-plane');
                        contentEl.setAttribute('color', '#dc3545'); // Color Rojo para destacar
                        contentEl.setAttribute('width', 1.5);
                        contentEl.setAttribute('height', 0.8);
                        contentEl.setAttribute('rotation', '-90 0 0');
                        contentEl.setAttribute('position', '0 0.5 0');
                        contentEl.setAttribute('onclick', `window.open('${config.resource}', '_blank')`);
                        
                        const textEl = document.createElement('a-text');
                        textEl.setAttribute('value', `Toca para ver ${key} (YouTube)`);
                        textEl.setAttribute('width', 3);
                        textEl.setAttribute('position', '0 0 0.05');
                        textEl.setAttribute('align', 'center');
                        contentEl.appendChild(textEl);
                    } else {
                        // Placeholder si el recurso no es reconocido
                        contentEl = document.createElement('a-plane');
                        contentEl.setAttribute('color', 'yellow');
                        contentEl.setAttribute('width', 1);
                        contentEl.setAttribute('height', 1);
                        contentEl.setAttribute('rotation', '-90 0 0');
                        contentEl.setAttribute('position', '0 0.5 0');
                        const textEl = document.createElement('a-text');
                        textEl.setAttribute('value', `Contenido ${key} No Definido`);
                        textEl.setAttribute('width', 2);
                        textEl.setAttribute('position', '0 0 0.05');
                        contentEl.appendChild(textEl);
                    }

                    // Propiedades necesarias para interactividad
                    contentEl.classList.add('clickable', 'gesturable'); 
                    contentEl.setAttribute('gesture-handler', '');

                    markerEl.appendChild(contentEl);
                    scene.insertBefore(markerEl, document.querySelector('a-entity[camera]'));
                });
            }


            // FUNCI√ìN CR√çTICA: Inicializaci√≥n forzada de la c√°mara con JS
            function initARScene() {
                const videoId = 'arjs-video-source';
                let videoEl = document.getElementById(videoId);

                // 1. Crear el elemento de video
                if (!videoEl) {
                    videoEl = document.createElement('video');
                    videoEl.setAttribute('id', videoId);
                    videoEl.setAttribute('autoplay', '');
                    videoEl.setAttribute('playsinline', '');
                    videoEl.setAttribute('muted', ''); 
                    videoEl.setAttribute('crossorigin', 'anonymous'); // ‚¨ÖÔ∏è CR√çTICO: Soluci√≥n para WebGL y fondo blanco
                    videoEl.setAttribute('style', 'position: absolute; top: 0; left: 0; z-index: -2; visibility: hidden;');
                    document.body.appendChild(videoEl);
                }

                // 2. Definir restricciones de alta calidad y c√°mara trasera
                const constraints = {
                    audio: false,
                    video: {
                        facingMode: { ideal: "environment" },
                        width: { ideal: 1280 },               
                        height: { ideal: 720 }                
                    }
                };

                // 3. Solicitar el stream y capturar permisos
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(stream) {
                        videoEl.srcObject = stream;
                        
                        videoEl.onloadedmetadata = function() {
                            videoEl.play();
                            
                            // 4. Inyectar la configuraci√≥n AR.js y la fuente de video
                            const scene = document.getElementById('scene');
                            if (scene) {
                                scene.setAttribute('arjs', 
                                    `sourceType: video; 
                                     sourceUrl: #${videoId}; 
                                     debugUIEnabled: true; 
                                     detectionMode: image; // Usamos 'image' ya que tienes archivos NFT
                                     // üí° FIX CR√çTICO: URL estable para el archivo de calibraci√≥n (c√≥digo 404)
                                     cameraParametersUrl: https://raw.githack.com/AR-js-org/AR.js/3.4.0/aframe/build/camera_para.dat;`);
                                
                                injectMarkers(scene); 
                            }
                        };
                    })
                    .catch(function(err) {
                        console.error("Error cr√≠tico al iniciar la c√°mara:", err);
                        alert(`Error de c√°mara: Aseg√∫rese de usar HTTPS y dar permisos. Causa: ${err.name}`);
                    });
            }

            document.addEventListener('DOMContentLoaded', initARScene); 

        </script>

        <style>
            .ar-warning {
                position: fixed; top: 10px; left: 10px; z-index: 1000;
                background: rgba(40, 167, 69, 0.8); color: white; padding: 10px; border-radius: 5px;
                font-family: sans-serif;
            }
        </style>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <div class="ar-warning">
            ‚úÖ FIX FINAL: Calibraci√≥n y WebGL corregidos. Limpie la cach√© y recargue.
        </div>
        <a-scene
            vr-mode-ui="enabled: false"
            loading-screen="enabled: false;"
            
            arjs='' 
              
            id="scene"
            embedded
            gesture-detector
            force-redraw 
        >
            <a-assets>
                </a-assets>

            <a-entity camera fov="80"></a-entity> 
        </a-scene>
    </body>
</html>
