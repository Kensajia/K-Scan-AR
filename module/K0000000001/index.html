<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>AR Experience - FIX WebRTC y Zoom</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        
        <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.6.0/dist/aframe-master.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
        
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        
        <script>
            // =====================================================================
            // 1. TABLA DE CONTENIDOS DIN√ÅMICA
            // =====================================================================
            const ContenidoModulo = { /* ... (Tus datos) ... */ };

            // =====================================================================
            // 2. L√ìGICA DE CONTROL DE ZOOM (ESCALADO DE CONTENIDO)
            // =====================================================================
            let currentScale = 1.0;
            const scaleStep = 0.1;

            function applyScale(scale) {
                const contentContainer = document.getElementById('ar-content');
                if (contentContainer) {
                    contentContainer.setAttribute('scale', `${scale} ${scale} ${scale}`);
                    currentScale = scale;
                    console.log(`Escala AR ajustada a: ${scale}`);
                }
            }
            window.zoomIn = function() { if (currentScale < 3.0) { applyScale(currentScale + scaleStep); } };
            window.zoomOut = function() { if (currentScale > 0.1) { applyScale(currentScale - scaleStep); } };
            window.zoomReset = function() { applyScale(1.0); };


            // =====================================================================
            // 3. FUNCI√ìN DE INYECCI√ìN DE MARCADORES
            // =====================================================================
            function injectMarkers() {
                const scene = document.getElementById('scene');
                const contentContainer = document.getElementById('ar-content');
                const urlParams = new URLSearchParams(window.location.search);
                const userCode = urlParams.get('code'); 
                const recursos = ContenidoModulo[userCode] || null;

                if (!recursos || !scene) return;
                
                const loader = document.querySelector('.arjs-loader');
                if (loader) {
                    loader.style.display = 'none';
                }
                
                // Aplicar escala inicial.
                applyScale(1.0); 

                // Aqu√≠ ir√≠a tu l√≥gica completa para crear y a√±adir <a-nft> y <a-marker>
                // a contentContainer. Por ahora, solo usamos un placeholder para la prueba.
                const markerKeys = Object.keys(recursos);
                markerKeys.forEach(key => {
                    const config = recursos[key];
                    if (config.type === "disabled") return;
                    
                    // Solo como ejemplo simplificado:
                    if (config.type === "nft") {
                        const markerEl = document.createElement('a-nft');
                        markerEl.setAttribute('type', 'nft');
                        markerEl.setAttribute('url', config.url); 
                        
                        const contentEl = document.createElement('a-box');
                        contentEl.setAttribute('position', '0 0 50');
                        contentEl.setAttribute('color', 'green');
                        
                        markerEl.appendChild(contentEl);
                        contentContainer.appendChild(markerEl); // <--- A√ëADIDO AL CONTENEDOR ESCALABLE
                    }
                });

            }
            
            // =====================================================================
            // 4. FIX CR√çTICO: Inicializaci√≥n forzada de la c√°mara con WebRTC
            // =====================================================================
            function initWebcamStream() {
                const videoId = 'arjs-video-source';
                let videoEl = document.createElement('video');
                videoEl.setAttribute('id', videoId);
                videoEl.setAttribute('autoplay', '');
                videoEl.setAttribute('playsinline', ''); 
                videoEl.setAttribute('muted', ''); 
                videoEl.setAttribute('crossorigin', 'anonymous'); 
                videoEl.setAttribute('style', 'position: absolute; top: 0; left: 0; z-index: -2; visibility: hidden;');
                document.body.appendChild(videoEl);

                // üí° FIX: Usar 'video: true' y anidar las restricciones detalladas
                const constraints = { 
                    audio: false, 
                    video: { 
                        facingMode: { ideal: "environment" }, 
                        width: { ideal: 1280 }, // Intentar una resoluci√≥n alta para evitar el recorte
                        height: { ideal: 720 } 
                    } 
                };

                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(stream) {
                        videoEl.srcObject = stream;
                        videoEl.onloadedmetadata = function() {
                            videoEl.play();
                            
                            const scene = document.getElementById('scene');
                            if (scene) {
                                // üí° AR.JS usar√° el video creado por WebRTC
                                scene.setAttribute('arjs', 
                                    `sourceType: video; 
                                     sourceUrl: #${videoId};
                                     trackingMethod: best; 
                                     debugUIEnabled: false;`);
                                
                                injectMarkers();
                            }
                        };
                    })
                    .catch(function(err) {
                        console.error("Error al iniciar la c√°mara (WebRTC):", err);
                        // Mostrar el error original en un mensaje m√°s claro
                        alert(`Error de c√°mara: Causa: ${err.name}. No se pudo aplicar el FIX de zoom por restricci√≥n del navegador.`);
                        
                        // Si falla WebRTC, recurrimos al m√©todo nativo simple para que al menos se vea la c√°mara
                        const scene = document.getElementById('scene');
                        if (scene) {
                             scene.setAttribute('arjs', 
                                `trackingMethod: best; 
                                 sourceType: webcam;
                                 debugUIEnabled: false;`);
                        }
                        injectMarkers(); 
                    });
            }

            document.addEventListener('DOMContentLoaded', initWebcamStream); 

        </script>

        <style> /* ... (Estilos de marquesina y controles) ... */ </style>
    </head>

    <body style="margin : 0px; overflow: hidden;">
        
        <div id="ar-controls">
            <button onclick="zoomOut()">‚ûñ Alejar</button>
            <button onclick="zoomReset()">üéØ Restaurar</button>
            <button onclick="zoomIn()">‚ûï Acercar</button>
        </div>

        <div class="arjs-loader">
            <div>Cargando archivos de realidad aumentada... (Intentando FIX de c√°mara WebRTC)</div>
        </div>
        
        <a-scene
            vr-mode-ui="enabled: false;"
            renderer="logarithmicDepthBuffer: true; precision: medium;"
            embedded
            // Temporalmente vac√≠o, se llenar√° en JS con la fuente de video
            arjs="" 
            id="scene"
        >
            <a-entity id="ar-content"></a-entity> 

            <a-entity camera></a-entity> 
        </a-scene>
    </body>
</html>
