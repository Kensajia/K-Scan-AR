<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>MindAR Three.js - FINAL (Carga Global CDN)</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        
        <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
        
        <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
        
        <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>

        <script>
            // Las librerías cargadas desde CDN crean estas variables globales
            const MINDAR = window.MINDAR;
            const THREE = window.THREE;
            
            // =====================================================================
            // 1. TABLA DE CONTENIDOS DINÁMICA
            // =====================================================================
            const ContenidoModulo = {
                "susam-51162": { 
                    "MARCADOR_A": { index: 0, resource: "https://www.youtube.com/embed/kRCWvqJVWx8?autoplay=1&controls=0", isClickable: true }, 
                    "MARCADOR_B": { index: 1, resource: "Contenido 3D (Caja)", isClickable: false }, 
                    "MARCADOR_C": { index: 2, resource: "Contenido 3D (Esfera)", isClickable: false } 
                },
            };

            document.addEventListener('DOMContentLoaded', () => {

                // =====================================================================
                // 2. INICIALIZACIÓN MINDAR
                // =====================================================================
                const mindarThree = new MINDAR.MindARThree({ 
                    container: document.querySelector("#container"),
                    // RUTA LOCAL CORRECTA ASUMIENDO QUE targets.mind está en module/K0000000001/assets/
                    imageTargetSrc: "assets/targets.mind" 
                });
                const {renderer, scene, camera} = mindarThree;
                
                // =====================================================================
                // 3. CREACIÓN DE CONTENIDO 3D DINÁMICO
                // =====================================================================
                function createContent(config) {
                    if (config.isClickable) {
                        // Plano interactivo (simula el video/enlace)
                        const geometry = new THREE.PlaneGeometry(1, 0.55);
                        const material = new THREE.MeshBasicMaterial( {color: 0x00ffff, transparent: true, opacity: 0.5} ); 
                        const plane = new THREE.Mesh( geometry, material );
                        
                        plane.userData.url = config.resource;
                        plane.position.set(0, 0, 0.05);
                        
                        return plane;

                    } else if (config.resource.includes("Caja")) {
                        // Cubo de prueba
                        const geometry = new THREE.BoxGeometry(1, 1, 1);
                        const material = new THREE.MeshBasicMaterial({ color: 0xFF0000 });
                        const box = new THREE.Mesh(geometry, material);
                        box.position.set(0, 0.5, 0); 
                        return box;
                    }
                    return new THREE.Object3D(); 
                }

                // Agrega los anclas y el contenido a la escena
                const urlParams = new URLSearchParams(window.location.search);
                const userCode = urlParams.get('code'); 
                const recursos = ContenidoModulo[userCode] || ContenidoModulo["susam-51162"];
                
                Object.values(recursos).forEach(config => {
                    if (config.index !== undefined) {
                        const anchor = mindarThree.addAnchor(config.index);
                        const content = createContent(config);
                        anchor.group.add(content);
                    }
                });

                // =====================================================================
                // 4. FUNCIONES DE RENDERIZADO Y CONTROL (START/STOP)
                // =====================================================================

                const start = async() => {
                    await mindarThree.start();
                    document.querySelector("#container").style.display = 'block';
                    document.querySelector("#startButton").style.display = 'none'; 
                    document.querySelector("#stopButton").style.display = 'block'; 

                    renderer.setAnimationLoop(() => {
                        renderer.render(scene, camera);
                    });
                }

                const stop = () => {
                    mindarThree.stop();
                    renderer.setAnimationLoop(null);
                    document.querySelector("#container").style.display = 'none'; 
                    document.querySelector("#startButton").style.display = 'block'; 
                    document.querySelector("#stopButton").style.display = 'none'; 
                }

                const startButton = document.querySelector("#startButton");
                const stopButton = document.querySelector("#stopButton");

                startButton.addEventListener("click", () => {
                    start();
                });

                stopButton.addEventListener("click", () => {
                    stop();
                });
                
                // Listener de Raycasting (Click en el objeto AR)
                window.addEventListener('click', (event) => {
                    const raycaster = new THREE.Raycaster();
                    const mouse = new THREE.Vector2();

                    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                    mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

                    raycaster.setFromCamera(mouse, camera);
                    
                    Object.values(recursos).forEach(config => {
                        if (config.index !== undefined && config.isClickable) {
                            const anchor = mindarThree.anchors[config.index];
                            if (anchor && anchor.group.children.length > 0) {
                                const intersects = raycaster.intersectObjects(anchor.group.children, true);
                                
                                if (intersects.length > 0 && intersects[0].object.userData.url) {
                                    window.open(intersects[0].object.userData.url, '_blank');
                                }
                            }
                        }
                    });
                });
            }); 
        </script>
        
        <style>
            body { margin: 0; }
            #container {
                width: 100vw;
                height: 100vh;
                position: relative;
                overflow: hidden;
                display: none; 
            }
            #control {
                position: fixed;
                top: 0;
                left: 0;
                z-index: 2;
                padding: 10px;
            }
            #stopButton { display: none; }
        </style>
    </head>
    
    <body>
        <div id="control">
            <button id="startButton">6 START AR</button> 
            <button id="stopButton">STOP AR</button>
        </div>
        <div id="container">
        </div>
    </body>
</html>
