<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>AR Experience - FIX FINAL Reorganizado</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@2.1.0/aframe/build/ar-nft.js"></script>
        
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        
        <script>
            const THREE = AFRAME.THREE;
            const ContenidoModulo = { /* ... (tus datos) ... */ };

            // =====================================================================
            // 2. COMPONENTES Y L√ìGICA DE INYECCI√ìN (sin cambios en la l√≥gica interna)
            // =====================================================================

            AFRAME.registerComponent('videohandler', { /* ... */ });
            AFRAME.registerComponent('force-redraw', { /* ... */ });
            AFRAME.registerComponent('force-video-texture', { /* ... */ });

            function injectMarkers(scene) { /* ... (Tu l√≥gica) ... */ }

            // FUNCI√ìN CR√çTICA: Inicializaci√≥n forzada de la c√°mara con JS
            function initARScene() {
                const videoId = 'arjs-video-source';
                let videoEl = document.getElementById(videoId);

                // 1. üí° FIX CR√çTICO: Aseguramos la creaci√≥n y asignaci√≥n de videoEl
                if (!videoEl) {
                    videoEl = document.createElement('video');
                    videoEl.setAttribute('id', videoId);
                    videoEl.setAttribute('autoplay', '');
                    videoEl.setAttribute('playsinline', ''); 
                    videoEl.setAttribute('muted', ''); 
                    videoEl.setAttribute('crossorigin', 'anonymous'); 
                    videoEl.setAttribute('style', 'position: absolute; top: 0; left: 0; z-index: -2; visibility: hidden;');
                    document.body.appendChild(videoEl);
                    console.log(`Elemento de video #${videoId} creado y a√±adido al DOM.`);
                } else {
                    console.log(`Elemento de video #${videoId} ya exist√≠a.`);
                }
                
                // videoEl AHORA ES DEFINITIVO y no puede ser undefined antes de la promesa

                // 2. Definir restricciones... 
                const constraints = { audio: false, video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } } };

                // 3. Solicitar el stream y capturar permisos
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(stream) {
                        // üí° ESTA ASIGNACI√ìN DEBE FUNCIONAR AHORA
                        videoEl.srcObject = stream; 
                        
                        videoEl.onloadedmetadata = function() {
                            videoEl.play();
                            
                            const scene = document.getElementById('scene');
                            if (scene) {
                                scene.setAttribute('arjs', 
                                    `sourceType: video; 
                                     debugUIEnabled: true; 
                                     detectionMode: nft;
                                     cameraParametersUrl: https://raw.githack.com/AR-js-org/AR.js/3.4.0/aframe/build/camera_para.dat;`);
                                
                                injectMarkers(scene);
                            }
                        };
                    })
                    .catch(function(err) {
                        console.error("Error cr√≠tico al iniciar la c√°mara:", err);
                        alert(`Error de c√°mara: Causa: ${err.name}`);
                    });
            }

            document.addEventListener('DOMContentLoaded', initARScene); 

        </script>
        <style> /* ... (Estilos) ... */ </style>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <div class="ar-warning">
            ‚úÖ INTENTO 100 - **FIX FINAL Reorganizado:** Corregido el error fatal `TypeError` y la sintaxis de A-Frame 1.0.4.
        </div>
        <a-scene
            vr-mode-ui="enabled: false"
            loading-screen="enabled: false;"
            

            renderer="colorManagement: false;" 

            arjs='' 
            id="scene"
            embedded
            gesture-detector
            force-redraw 
            force-video-texture 
        >
            <a-assets>
                </a-assets>

            <a-entity camera fov="80"></a-entity> 
        </a-scene>
    </body>
</html>
