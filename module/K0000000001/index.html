<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>AR Experience - KScan</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/ar.js"></script>
        
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        
        <script>
            // =====================================================================
            // 1. TABLA DE CONTENIDOS DINÁMICA DEL MÓDULO AR
            // =====================================================================
            // La estructura mapea: CÓDIGO ÚNICO -> MARCADOR -> CONFIGURACIÓN
            const ContenidoModulo = {
                // EJEMPLO DE CONFIGURACIÓN CON AMBOS TIPOS DE MARCADOR
                "susam-51162": { 
                    // MARCADOR B: Usa IMAGEN NATURAL (Sin Cuadro Negro - Requiere .fset, .iset, .fset3)
                    "MARCADOR_A": { 
                        type: "pattern", 
                        url: "assets/T000001-SUSAM-01.fset", 
                        resource: "https://www.youtube.com/embed/kRCWvqJVWx8" // YouTube
                    }, 
                    // MARCADOR B: Usa IMAGEN NATURAL (Sin Cuadro Negro - Requiere .fset, .iset, .fset3)
                    "MARCADOR_B": { 
                        type: "image", 
                        url: "assets/postal1.fset", 
                        resource: "assets/modelo_3d.glb" // Modelo 3D
                    }, 
                    // MARCADOR C: Desactivado
                    "MARCADOR_C": { type: "disabled" } 
                },
                // Si tienes otros códigos en esta misma carpeta, van aquí:
                "otroCodigoEjemplo": { /* ... */ }
            };

            // =====================================================================
            // 2. COMPONENTES DE A-FRAME
            // =====================================================================

            // Componente para manejar la reproducción de VIDEO LOCAL
            AFRAME.registerComponent('videohandler', {
                schema: { targetId: {type: 'string'} },
                init: function () {
                    var marker = this.el;
                    const videoEl = document.querySelector(`#${this.data.targetId}`);
                    
                    marker.addEventListener('markerFound', function () { if (videoEl) { videoEl.play(); } }.bind(this));
                    marker.addEventListener('markerLost', function () { if (videoEl) { videoEl.pause(); } }.bind(this));
                },
            });

            // =====================================================================
            // 3. INYECCIÓN DE CONTENIDO Y CONFIGURACIÓN DE ESCENA
            // =====================================================================
            document.addEventListener('DOMContentLoaded', () => {
                const urlParams = new URLSearchParams(window.location.search);
                const userCode = urlParams.get('code'); 
                const recursos = ContenidoModulo[userCode] || null;

                if (!recursos) {
                    if (!ContenidoModulo[userCode]) alert("Error: No se encontró contenido AR para este código.");
                    return; 
                }
                
                const markerKeys = Object.keys(recursos);
                const scene = document.getElementById('scene');
                const assetsEl = document.querySelector('a-assets');
                
                markerKeys.forEach(key => {
                    const config = recursos[key];
                    if (config.type === "disabled") return;

                    const markerEl = document.createElement('a-marker');
                    
                    // Configuración básica del marcador
                    markerEl.setAttribute('type', config.type);
                    markerEl.setAttribute('preset', 'custom');
                    markerEl.setAttribute('url', config.url);
                    markerEl.setAttribute('id', key);
                    
                    // Necesario para que funcione el zoom manual con gestos
                    markerEl.setAttribute('raycaster', 'objects: .clickable');
                    markerEl.setAttribute('emitevents', 'true');
                    markerEl.setAttribute('cursor', 'fuse: false; rayOrigin: mouse;');

                    let contentEl;
                    
                    if (config.resource.endsWith('.glb')) {
                        // Modelo 3D (.glb)
                        contentEl = document.createElement('a-gltf-model');
                        contentEl.setAttribute('src', config.resource);
                        contentEl.setAttribute('scale', '0.5 0.5 0.5'); 
                        contentEl.setAttribute('rotation', '-90 0 0');
                        contentEl.classList.add('clickable', 'gesturable');

                    } else if (config.resource.includes('youtube') || config.resource.includes('youtu.be')) {
                        // YouTube (Plano clickable)
                        contentEl = document.createElement('a-plane');
                        contentEl.setAttribute('color', '#333');
                        contentEl.setAttribute('width', 1.5);
                        contentEl.setAttribute('height', 0.8);
                        contentEl.setAttribute('rotation', '-90 0 0');
                        contentEl.setAttribute('position', '0 0.5 0');
                        contentEl.setAttribute('onclick', `window.open('${config.resource}', '_blank')`);
                        
                        const textEl = document.createElement('a-text');
                        textEl.setAttribute('value', `Toca para ver ${key}`);
                        textEl.setAttribute('width', 3);
                        textEl.setAttribute('position', '0 0 0.05');
                        textEl.setAttribute('align', 'center');
                        contentEl.appendChild(textEl);
                        contentEl.classList.add('clickable');
                        
                    } else if (config.resource.endsWith('.mp4') || config.resource.endsWith('.webm')) {
                        // Video Local
                        const videoAssetId = `vid-${key}`;
                        
                        // 1. Añadir video a a-assets (si no existe)
                        if (!document.getElementById(videoAssetId)) {
                            const videoEl = document.createElement('video');
                            videoEl.setAttribute('id', videoAssetId);
                            videoEl.setAttribute('src', config.resource);
                            videoEl.setAttribute('preload', 'auto');
                            videoEl.setAttribute('loop', '');
                            videoEl.setAttribute('muted', '');
                            videoEl.setAttribute('crossorigin', '');
                            videoEl.setAttribute('playsinline', '');
                            assetsEl.appendChild(videoEl);
                        }

                        // 2. Crear el componente a-video
                        contentEl = document.createElement('a-video');
                        contentEl.setAttribute('src', `#${videoAssetId}`);
                        contentEl.setAttribute('scale', '1 1 1');
                        contentEl.setAttribute('rotation', '-90 0 0');
                        contentEl.setAttribute('position', '0 0.1 0');
                        markerEl.setAttribute('videohandler', `targetId: ${videoAssetId}`);
                        contentEl.classList.add('clickable', 'gesturable'); // Para gestos
                    }
                    
                    if (contentEl) {
                        contentEl.setAttribute('gesture-handler', ''); // Aplicar manejador de gestos
                        markerEl.appendChild(contentEl);
                    }
                    
                    scene.insertBefore(markerEl, document.querySelector('a-entity[camera]'));
                });
            });

        </script>

        <style>
            .ar-warning {
                position: fixed; top: 10px; left: 10px; z-index: 1000;
                background: rgba(23, 162, 184, 0.8); color: white; padding: 10px; border-radius: 5px;
                font-family: sans-serif;
            }
        </style>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <div class="ar-warning">
            ✅ Intento 2: Versión 1.5.0: Forzando 1280x720 y calibración de cámara. Limpia la caché.
        </div>
        <a-scene
    vr-mode-ui="enabled: false"
    loading-screen="enabled: false;"
    

    arjs='sourceType: webcam; 
          debugUIEnabled: false;

          detectionMode: mono; 

          cameraParametersUrl: https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/camera_para.dat;' 
          
    id="scene"
    embedded
>
    </a-scene>
        >
            <a-assets>
                </a-assets>

            <a-entity camera fov="80"></a-entity> 
        </a-scene>
    </body>
</html>
