<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>AR Experience - KScan</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        
        <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/ar.js"></script>
        
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        
        <script>
    // =====================================================================
    // 1. TABLA DE CONTENIDOS DINMICA DEL MDULO AR
    // =====================================================================
    const ContenidoModulo = {
        "susam-51162": { 
            "MARCADOR_A": { type: "pattern", url: "assets/taza.patt", resource: "https://www.youtube.com/embed/kRCWvqJVWx8" }, 
            "MARCADOR_B": { type: "image", url: "assets/postal1.fset", resource: "assets/modelo_3d.glb" }, 
            "MARCADOR_C": { type: "disabled" } 
        },
        "otroCodigoEjemplo": { /* ... */ }
    };

    // =====================================================================
    // 2. COMPONENTES DE A-FRAME Y FIX DE CMARA
    // =====================================================================

    // Componente para manejar la reproducci贸n de VIDEO LOCAL
    AFRAME.registerComponent('videohandler', {
        schema: { targetId: {type: 'string'} },
        init: function () {
            var marker = this.el;
            const videoEl = document.querySelector(`#${this.data.targetId}`);
            
            marker.addEventListener('markerFound', function () { if (videoEl) { videoEl.play(); } }.bind(this));
            marker.addEventListener('markerLost', function () { if (videoEl) { videoEl.pause(); } }.bind(this));
        },
    });

    //  SOLUCIN 2: FIX para forzar la c谩mara trasera si la inicializaci贸n falla
    AFRAME.registerComponent('ar-fix-facing', {
        init: function () {
            setTimeout(() => {
                const video = document.querySelector('video');
                if (video && video.srcObject) {
                    const tracks = video.srcObject.getVideoTracks();
                    if (tracks.length > 0) {
                        // Intenta aplicar las restricciones, forzando la c谩mara trasera
                        tracks[0].applyConstraints({
                            advanced: [{ facingMode: "environment" }]
                        }).catch(e => console.warn("No se pudo aplicar facingMode:", e));
                    }
                }
            }, 1000); // Dar 1 segundo para que la escena intente iniciar
        }
    });

    // =====================================================================
    // 3. INYECCIN DE CONTENIDO Y CONFIGURACIN DE ESCENA
    // =====================================================================
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const userCode = urlParams.get('code'); 
        const recursos = ContenidoModulo[userCode] || null;

        if (!recursos) {
            if (!ContenidoModulo[userCode]) alert("Error: No se encontr贸 contenido AR para este c贸digo.");
            return; 
        }
        
        const markerKeys = Object.keys(recursos);
        const scene = document.getElementById('scene');
        const assetsEl = document.querySelector('a-assets');
        
        markerKeys.forEach(key => {
            const config = recursos[key];
            if (config.type === "disabled") return;

            const markerEl = document.createElement('a-marker');
            markerEl.setAttribute('type', config.type);
            markerEl.setAttribute('preset', 'custom');
            markerEl.setAttribute('url', config.url);
            markerEl.setAttribute('id', key);
            markerEl.setAttribute('raycaster', 'objects: .clickable');
            markerEl.setAttribute('emitevents', 'true');
            markerEl.setAttribute('cursor', 'fuse: false; rayOrigin: mouse;');

            // L贸gica de inyecci贸n de contenido (Modelo 3D, YouTube, Video Local, etc.)
            let contentEl;
            
            if (config.resource.endsWith('.glb')) {
                contentEl = document.createElement('a-gltf-model');
                contentEl.setAttribute('src', config.resource);
                contentEl.setAttribute('scale', '0.5 0.5 0.5'); 
                contentEl.setAttribute('rotation', '-90 0 0');
                contentEl.classList.add('clickable', 'gesturable');
            } else {
                // Generamos un plano gen茅rico como marcador de posici贸n
                contentEl = document.createElement('a-plane');
                contentEl.setAttribute('color', 'blue');
                contentEl.setAttribute('width', 1);
                contentEl.setAttribute('height', 1);
                contentEl.setAttribute('rotation', '-90 0 0');
                contentEl.setAttribute('position', '0 0.5 0');
                const textEl = document.createElement('a-text');
                textEl.setAttribute('value', key);
                textEl.setAttribute('width', 2);
                textEl.setAttribute('position', '0 0 0.05');
                contentEl.appendChild(textEl);
                contentEl.classList.add('clickable', 'gesturable');
            }
            
            if (contentEl) {
                contentEl.setAttribute('gesture-handler', ''); 
                markerEl.appendChild(contentEl);
            }
            
            scene.insertBefore(markerEl, document.querySelector('a-entity[camera]'));
        });
    });

</script>

        <style>
            .ar-warning {
                position: fixed; top: 10px; left: 10px; z-index: 1000;
                background: rgba(23, 162, 184, 0.8); color: white; padding: 10px; border-radius: 5px;
                font-family: sans-serif;
            }
        </style>
    </head>

<body style="margin: 0; overflow: hidden;">
    <div class="ar-warning">
         FIX CRTICO: Intentando forzar la inicializaci贸n y la c谩mara trasera.
    </div>
    <a-scene
        vr-mode-ui="enabled: false"
        loading-screen="enabled: false;"
        

        arjs='sourceType: webcam; 
              debugUIEnabled: false;
              detectionMode: mono; 
              cameraParametersUrl: https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/camera_para.dat;' 
              
        id="scene"
        embedded
        gesture-detector
        ar-fix-facing
    >
        <a-assets>
            </a-assets>

        <a-entity camera fov="80"></a-entity> 
    </a-scene>
</body>
</html>
